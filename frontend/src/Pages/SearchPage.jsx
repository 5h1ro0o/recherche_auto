// frontend/src/Pages/SearchPage.jsx
import React, { useState } from 'react'
import SearchBar from '../ui/SearchBar'
import Results from '../ui/Results'
import ChatBot from '../components/ChatBot'
import { useSearch } from '../services/useSearch'

export default function SearchPage() {
  const [q, setQ] = useState('')
  const [filters, setFilters] = useState({})
  const [page, setPage] = useState(1)
  const [enableScraping, setEnableScraping] = useState(true) // ACTIV√â pour scraper les plateformes
  const [scrapingMode, setScrapingMode] = useState('always') // 'always' = toujours scraper

  // Utiliser le hook useSearch pour r√©cup√©rer les r√©sultats
  const { data, loading, error, refetch } = useSearch(q, page, filters, enableScraping, scrapingMode)

  // Extraire les r√©sultats et le total des donn√©es
  const results = data?.results || []
  const total = data?.total || 0

  function onSearch(term) {
    setQ(term)
    setPage(1)
    refetch()
  }

  // Callback quand le chatbot d√©tecte des filtres
  function handleFiltersDetected(detectedFilters) {
    console.log('Filtres d√©tect√©s par IA:', detectedFilters)
    setFilters(detectedFilters)
    setPage(1)
  }

  // Callback quand le chatbot retourne des r√©sultats
  function handleSearchResults(hits, totalResults) {
    // Le chatbot peut aussi retourner des r√©sultats directement
    // Dans ce cas, on pourrait les afficher
    console.log('R√©sultats du chatbot:', hits, totalResults)
  }

  return (
    <div className="search-page">
      <div className="search-header">
        <h1>Recherche de v√©hicules</h1>
        <p className="search-subtitle">
          üéØ Utilisez la barre de recherche ou le chatbot pour trouver votre v√©hicule
        </p>
      </div>

      <SearchBar onSearch={onSearch} defaultValue={q} />

      {/* Affichage des filtres d√©tect√©s */}
      {Object.keys(filters).length > 0 && (
        <div className="detected-filters">
          <h4>üîç Filtres actifs :</h4>
          <div className="filters-list">
            {Object.entries(filters).map(([key, value]) => (
              <span key={key} className="filter-chip">
                <strong>{key}:</strong> {value}
              </span>
            ))}
          </div>
        </div>
      )}

      {/* Affichage d'erreur si n√©cessaire */}
      {error && (
        <div className="search-error" style={{ padding: '20px', margin: '20px', backgroundColor: '#fee', borderRadius: '8px' }}>
          <p style={{ color: '#c00' }}>‚ùå Erreur: {error}</p>
        </div>
      )}

      {/* Statistiques de scraping */}
      {data && data.sources && (
        <div className="scraping-stats" style={{ padding: '10px', margin: '10px 0', backgroundColor: '#e8f5e9', borderRadius: '8px' }}>
          <p>
            üìä R√©sultats: {data.from_db || 0} de la base de donn√©es + {data.from_scraping || 0} du scraping
            {data.sources && Object.keys(data.sources).length > 0 && (
              <span> (Sources: {Object.keys(data.sources).filter(k => data.sources[k].success).join(', ')})</span>
            )}
          </p>
        </div>
      )}

      <Results
        loading={loading}
        results={results}
        total={total}
        page={page}
        onPageChange={setPage}
      />

      {/* ChatBot flottant */}
      <ChatBot
        onFiltersDetected={handleFiltersDetected}
        onSearchResults={handleSearchResults}
      />
    </div>
  )
}