# Guide de D√©marrage - Plateforme de Recherche Automobile

Ce guide vous accompagne pas √† pas pour installer et d√©marrer le projet complet.

## Architecture du Projet

- **Backend** : FastAPI (Python) - API REST
- **Frontend** : React + Vite
- **Base de donn√©es** : PostgreSQL 17
- **Search Engine** : Elasticsearch (optionnel pour commencer)
- **Cache/Queue** : Redis (optionnel pour commencer)
- **Worker** : Celery pour les t√¢ches asynchrones (optionnel)

## Pr√©requis

### Obligatoires

- **Python 3.10+** (recommand√© : 3.11 ou 3.12, √©viter 3.13 si possible pour la compatibilit√©)
- **Node.js 18+** et npm
- **PostgreSQL 17** (ou 15+)
- **Git**

### Optionnels (pour les fonctionnalit√©s avanc√©es)

- **Elasticsearch 8+** (pour la recherche avanc√©e)
- **Redis** (pour le cache et Celery)
- **MinIO** (pour le stockage d'images)

## üöÄ Installation Rapide (Mode D√©butant)

### √âtape 1 : Cloner le projet

```bash
git clone <url-du-repo>
cd recherche_auto
```

### √âtape 2 : Configuration de PostgreSQL

#### 2.1 Cr√©er la base de donn√©es

Ouvrez psql ou pgAdmin et ex√©cutez :

```sql
-- Cr√©er la base de donn√©es
CREATE DATABASE recherche_auto
    ENCODING 'UTF8'
    LC_COLLATE = 'French_France.1252'
    LC_CTYPE = 'French_France.1252';

-- Cr√©er l'utilisateur app (si pas d√©j√† existant)
CREATE USER app WITH PASSWORD 'changeme';

-- Donner les droits
GRANT ALL PRIVILEGES ON DATABASE recherche_auto TO app;

-- Se connecter √† la base de donn√©es
\c recherche_auto

-- Donner les droits sur le sch√©ma public
GRANT ALL PRIVILEGES ON SCHEMA public TO app;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO app;
```

#### 2.2 V√©rifier la connexion

```bash
cd backend
python check_db_encoding.py
```

Vous devriez voir :
```
Encodage de la base de donn√©es: UTF8
LC_COLLATE: French_France.1252
LC_CTYPE: French_France.1252
‚úì V√©rification termin√©e avec succ√®s
```

### √âtape 3 : Configuration du Backend

#### 3.1 Cr√©er l'environnement virtuel Python

```bash
cd backend
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

#### 3.2 Installer les d√©pendances

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

**Note** : Si vous rencontrez des erreurs avec Playwright sur Windows :
```bash
# Installer les navigateurs Playwright
playwright install chromium
```

#### 3.3 Configuration de l'environnement

Cr√©er le fichier `.env` dans le dossier `backend/` :

```bash
# Windows PowerShell
copy .env.example .env

# Linux/Mac
cp .env.example .env
```

√âditer le fichier `.env` et v√©rifier les valeurs :

```env
DATABASE_URL=postgresql+psycopg2://app:changeme@127.0.0.1:5432/recherche_auto
SECRET_KEY=votre-cle-secrete-super-longue-et-aleatoire
LOG_LEVEL=INFO
```

**Important** : Changez `SECRET_KEY` pour quelque chose d'unique !

#### 3.4 Initialiser la base de donn√©es

```bash
# Cr√©er les tables avec Alembic
alembic upgrade head
```

Si tout se passe bien, vous devriez voir :
```
INFO  [alembic.runtime.migration] Running upgrade -> xxx, create_vehicles
INFO  [alembic.runtime.migration] Running upgrade xxx -> yyy, add_users_roles
...
```

#### 3.5 Cr√©er un utilisateur admin (optionnel)

Cr√©ez un script `create_admin.py` dans `backend/` :

```python
from app.db import SessionLocal
from app.models import User, UserRole
from app.auth import get_password_hash
import uuid

db = SessionLocal()

admin_user = User(
    id=str(uuid.uuid4()),
    email="admin@example.com",
    hashed_password=get_password_hash("admin123"),
    full_name="Administrateur",
    role=UserRole.ADMIN,
    is_active=True,
    is_verified=True
)

db.add(admin_user)
db.commit()
print(f"‚úì Utilisateur admin cr√©√© : {admin_user.email}")
db.close()
```

Puis ex√©cutez :
```bash
python create_admin.py
```

#### 3.6 D√©marrer le serveur backend

```bash
# Mode d√©veloppement avec rechargement automatique
uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
```

Vous devriez voir :
```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

Testez l'API : http://127.0.0.1:8000 devrait afficher `{"message": "API ok", "version": "0.2.0"}`

Documentation interactive : http://127.0.0.1:8000/docs

### √âtape 4 : Configuration du Frontend

#### 4.1 Installer les d√©pendances

Ouvrez un **nouveau terminal** (laissez le backend tourner) :

```bash
cd frontend
npm install
```

#### 4.2 Configuration de l'environnement

```bash
# Windows PowerShell
copy .env.example .env

# Linux/Mac
cp .env.example .env
```

Le fichier `.env` devrait contenir :
```env
VITE_API_URL=http://localhost:8000
```

#### 4.3 D√©marrer le serveur frontend

```bash
npm run dev
```

Vous devriez voir :
```
  VITE v5.x.x  ready in xxx ms

  ‚ûú  Local:   http://localhost:5173/
  ‚ûú  Network: use --host to expose
```

### √âtape 5 : Tester l'Application

Ouvrez votre navigateur sur http://localhost:5173

#### Test 1 : Inscription

1. Allez sur la page d'inscription
2. Cr√©ez un compte avec :
   - Email : `test@example.com`
   - Mot de passe : `Test123!`
   - Nom complet : `Test User`
   - R√¥le : `PARTICULAR` (Particulier)

3. Cliquez sur "S'inscrire"

#### Test 2 : Connexion

1. Allez sur la page de connexion
2. Connectez-vous avec les identifiants cr√©√©s

#### Test 3 : Recherche

1. Une fois connect√©, allez sur la page de recherche
2. Essayez une recherche (ex: "Peugeot 308")
3. **Note** : Les r√©sultats seront vides car il n'y a pas encore de v√©hicules dans la base

## üîß Commandes Utiles

### Backend

```bash
# Activer l'environnement virtuel
cd backend
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac

# D√©marrer le serveur
uvicorn app.main:app --reload

# Cr√©er une nouvelle migration
alembic revision --autogenerate -m "description"

# Appliquer les migrations
alembic upgrade head

# Voir l'historique des migrations
alembic history

# V√©rifier la base de donn√©es
python check_db_encoding.py
```

### Frontend

```bash
cd frontend

# Installer les d√©pendances
npm install

# D√©marrer en mode d√©veloppement
npm run dev

# Build pour la production
npm run build

# Pr√©visualiser le build de production
npm run preview

# Linter
npm run lint
```

## üêõ D√©pannage

### Erreur : "Base de donn√©es 'vehicles' n'existe pas"

**Solution** : Le nom de la base a √©t√© corrig√©. Assurez-vous que votre `.env` pointe vers `recherche_auto` :
```env
DATABASE_URL=postgresql+psycopg2://app:changeme@127.0.0.1:5432/recherche_auto
```

### Erreur : "UnicodeDecodeError" avec psycopg2

**Solution** : Utilisez le script `check_db_encoding.py` qui contourne ce probl√®me.

### Erreur : "Module 'app' not found"

**Solution** : Assurez-vous d'√™tre dans le dossier `backend/` et que l'environnement virtuel est activ√©.

### Le frontend ne se connecte pas au backend

**Solution** :
1. V√©rifiez que le backend tourne sur http://localhost:8000
2. V√©rifiez le fichier `frontend/.env` : `VITE_API_URL=http://localhost:8000`
3. Red√©marrez le serveur frontend apr√®s modification du `.env`

### Erreurs CORS

**Solution** : Le backend est configur√© pour accepter `localhost:5173`. Si vous utilisez un autre port, modifiez `backend/.env` :
```env
ALLOW_ORIGINS=http://localhost:5173,http://localhost:VOTRE_PORT
```

## üì¶ Fonctionnalit√©s Avanc√©es (Optionnel)

### Installation d'Elasticsearch

Pour activer la recherche avanc√©e :

```bash
# T√©l√©charger Elasticsearch 8.x depuis elastic.co
# D√©marrer Elasticsearch
# Par d√©faut sur http://localhost:9200

# V√©rifier dans backend/.env :
ELASTIC_HOST=http://localhost:9200
ES_INDEX=vehicles
```

### Installation de Redis

Pour le cache et Celery :

```bash
# Windows : T√©l√©charger Redis depuis GitHub (tporadowski/redis)
# Linux : sudo apt install redis-server
# Mac : brew install redis

# D√©marrer Redis
redis-server

# V√©rifier dans backend/.env :
REDIS_URL=redis://127.0.0.1:6379/0
```

### D√©marrer Celery Worker

Pour les t√¢ches asynchrones (scraping, etc.) :

```bash
cd backend

# Windows
celery -A app.celery_app worker --loglevel=info --pool=solo

# Linux/Mac
celery -A app.celery_app worker --loglevel=info
```

### D√©marrer Flower (Monitoring Celery)

```bash
celery -A app.celery_app flower --port=5555
```

Acc√©dez √† http://localhost:5555

## üéØ Prochaines √âtapes

1. **Ajouter des v√©hicules de test** : Utilisez l'API `/api/admin/vehicles` pour ajouter des v√©hicules
2. **Configurer le scraping** : Consultez `backend/scrapers/` pour automatiser la collecte de donn√©es
3. **Personnaliser le frontend** : Modifiez les composants dans `frontend/src/components/`
4. **Configurer l'authentification par email** : Int√©grez un service d'envoi d'emails

## üìö Documentation Suppl√©mentaire

- **API Documentation** : http://localhost:8000/docs (Swagger)
- **API Redoc** : http://localhost:8000/redoc
- **Frontend Components** : Voir `frontend/src/components/`
- **Backend Routes** : Voir `backend/app/routes/`

## üÜò Besoin d'Aide ?

- Consultez les logs du backend dans le terminal
- Consultez les logs du frontend dans la console du navigateur (F12)
- V√©rifiez les issues GitHub du projet

## ‚úÖ Checklist de D√©marrage

- [ ] PostgreSQL 17 install√© et configur√©
- [ ] Base de donn√©es `recherche_auto` cr√©√©e
- [ ] Utilisateur `app` avec mot de passe `changeme` cr√©√©
- [ ] Python 3.10+ install√©
- [ ] Node.js 18+ install√©
- [ ] Backend : environnement virtuel cr√©√© et activ√©
- [ ] Backend : d√©pendances install√©es (`pip install -r requirements.txt`)
- [ ] Backend : fichier `.env` configur√©
- [ ] Backend : migrations appliqu√©es (`alembic upgrade head`)
- [ ] Backend : serveur d√©marr√© (http://localhost:8000)
- [ ] Frontend : d√©pendances install√©es (`npm install`)
- [ ] Frontend : fichier `.env` configur√©
- [ ] Frontend : serveur d√©marr√© (http://localhost:5173)
- [ ] Test d'inscription effectu√©
- [ ] Test de connexion effectu√©

Bon d√©veloppement ! üöóüí®
