"""
Script pour tester la connexion √† PostgreSQL
"""
import os
import sys
from sqlalchemy import create_engine, text
from dotenv import load_dotenv

# Charger les variables d'environnement
load_dotenv()

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+psycopg2://postgres:postgres@localhost:5432/recherche_auto")

print(f"üîç Test de connexion √† la base de donn√©es...")
print(f"üìç URL: {DATABASE_URL.replace(DATABASE_URL.split('@')[0].split('//')[1], '***:***')}")

try:
    # Cr√©er un engine
    engine = create_engine(DATABASE_URL, echo=False)

    # Tester la connexion
    with engine.connect() as conn:
        result = conn.execute(text("SELECT version();"))
        version = result.fetchone()[0]
        print(f"‚úÖ Connexion r√©ussie !")
        print(f"üìä PostgreSQL version: {version}")

        # V√©rifier les tables existantes
        result = conn.execute(text("""
            SELECT tablename
            FROM pg_catalog.pg_tables
            WHERE schemaname = 'public'
            ORDER BY tablename;
        """))
        tables = [row[0] for row in result.fetchall()]

        if tables:
            print(f"\nüìã Tables existantes ({len(tables)}):")
            for table in tables:
                print(f"  - {table}")
        else:
            print(f"\n‚ö†Ô∏è  Aucune table trouv√©e. Vous devez ex√©cuter les migrations Alembic.")
            print(f"   Commande: alembic upgrade head")

        sys.exit(0)

except Exception as e:
    print(f"‚ùå Erreur de connexion !")
    print(f"üí• {type(e).__name__}: {e}")
    print(f"\nüìù Solutions possibles:")
    print(f"  1. V√©rifier que PostgreSQL est install√© et d√©marr√©")
    print(f"  2. V√©rifier les identifiants dans le fichier .env")
    print(f"  3. Cr√©er la base de donn√©es 'recherche_auto' si elle n'existe pas")
    print(f"\nüîß Pour installer PostgreSQL sur Windows:")
    print(f"  - T√©l√©charger: https://www.postgresql.org/download/windows/")
    print(f"  - Ou utiliser: winget install PostgreSQL.PostgreSQL")
    print(f"\nüîß Pour cr√©er la base de donn√©es:")
    print(f"  psql -U postgres")
    print(f"  CREATE DATABASE recherche_auto;")
    sys.exit(1)
