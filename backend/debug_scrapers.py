# backend/debug_scrapers.py
"""
Script de d√©bogage pour visualiser la structure HTML des sites
et trouver les bons s√©lecteurs CSS
"""
import logging
from scrapers.base_scraper import BaseScraper

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class DebugScraper(BaseScraper):
    """Scraper de d√©bogage pour inspecter la structure HTML"""

    def get_source_name(self):
        return "debug"

    def scrape(self, search_params):
        return []

    def inspect_page(self, url: str):
        """Inspecte une page et affiche sa structure"""
        try:
            self.init_browser(headless=False)  # Mode visible pour debug

            logger.info(f"üìç Chargement de: {url}")
            self.page.goto(url, wait_until='networkidle', timeout=30000)
            self.random_delay(3, 5)

            # Afficher le HTML
            html = self.page.content()
            logger.info(f"üìÑ HTML de la page (premiers 2000 caract√®res):")
            print("="*80)
            print(html[:2000])
            print("="*80)

            # Essayer de trouver les √©l√©ments avec diff√©rents s√©lecteurs
            logger.info("\nüîç Test des s√©lecteurs...")

            selectors_to_test = [
                'article',
                'div',
                'a[href*="voitures"]',
                'a[href*="auto"]',
                'a[href*="ad"]',
                '[data-qa-id]',
                '[class*="card"]',
                '[class*="item"]',
                '[class*="listing"]',
                '[class*="ad"]',
            ]

            for selector in selectors_to_test:
                try:
                    elements = self.page.query_selector_all(selector)
                    if elements and len(elements) > 0:
                        print(f"‚úÖ {selector}: {len(elements)} √©l√©ments trouv√©s")

                        # Afficher le HTML du premier √©l√©ment
                        if elements:
                            first_elem_html = elements[0].inner_html()[:300]
                            print(f"   Premier √©l√©ment: {first_elem_html}...")
                    else:
                        print(f"‚ùå {selector}: 0 √©l√©ments")
                except Exception as e:
                    print(f"‚ö†Ô∏è {selector}: Erreur - {e}")

            input("\n‚è∏Ô∏è Appuyez sur Entr√©e pour fermer le navigateur...")

        except Exception as e:
            logger.error(f"Erreur: {e}")
        finally:
            self.close_browser()

if __name__ == '__main__':
    print("üîß Script de d√©bogage des scrapers")
    print("="*80)

    debug = DebugScraper()

    # Tester LeBonCoin
    print("\n1Ô∏è‚É£ Test LeBonCoin")
    debug.inspect_page("https://www.leboncoin.fr/recherche?category=2&text=Peugeot")

    # D√©commenter pour tester les autres sites :
    # print("\n2Ô∏è‚É£ Test La Centrale")
    # debug.inspect_page("https://www.lacentrale.fr/listing?makesModelsCommercialNames=Peugeot")

    # print("\n3Ô∏è‚É£ Test AutoScout24")
    # debug.inspect_page("https://www.autoscout24.fr/lst?sort=standard&desc=0&ustate=N%2CU&size=20&page=0&atype=C")
